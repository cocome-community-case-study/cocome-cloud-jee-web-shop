---

Instructions to set up CoCoME Pickup Shop Eclipse environment

---

== Prerequisits ==

- Eclipse with Java EE support
- Glassfish 4.0 or higher (or Glassfish 3.1)

Quick Facts:
${GLASSFISH} - path to the Glassfish installation
${HOME}      - home folder of your user account

== Preparations ==

1. Install Glassfish

This will usually create a domain named 'domain1'. We assume that you
installed Glassfish in a directory represented by the variable
${GLASSFISH}, which we use in the remainder of this document to refer 
to the installation directory.

Note: in Unix/Linux path names use / and in Windows \. This may require
escaping in certain places, i.e., \\ for a \.

Glassfish is usually installed with the following layout:
${GLASSFISH}/bin
${GLASSFISH}/glassfish
${GLASSFISH}/javadb
${GLASSFISH}/mq
${GLASSFISH}/pkg
${GLASSFISH}/README.txt


2. Configure Glassfish Domains

We must create one Glassfish domain for the pickup shop website.

The domain name is:
- cocome-pickup

2.1 Create domain using asadmin

Each domain requires their own port numbers for the service and
administration. The defaults are 8080 for the service and 4848 for the
administration interface. However, to avoid conflict with running
systems we define:
- cocome-pickup: admin 8548, service 8580

You may choose other port numbers, especially when on of these ports is
already in use. You may not be able to select port numbers below 32000,
as this can be prohibited by firewalls.

a) Change to ${GLASSFISH}/glassfish 
b) Execute bin/asadmin as follows. The tool will prompt for a password.
   You may leave that empty.

    bin/asadmin create-domain --portbase 8500 cocome-pickup
    

Note: It is best to start each domain before creating the next when using 
this method. Otherwise both domains may end up using the same ports, for 
example for the jmx service, which will then cause a conflict if both 
domains are started on the same host.

2.2 Create domain using Eclipse

If you installed the Glassfish Tools from the Oracle Enterprise Pack 
for Eclipse you can create a new domain directly from within Eclipse. 
To do this, open the Servers view in Eclipse and add a new server with 
Right-Click -> New -> Server. In the wizard, select Glassfish in the 
version you use and enter cocome-logic or cocome-web as the server name.

In the next step of this wizard click on the "+" signs to the right of 
the domain path field. This opens a new dialogue. In the name field 
insert cocome-logic or cocome-web. The domain directory should already point 
to ${GLASSFISH}/domains and should not be modified. The portbase 
is used to compute the ports for this domain. Portbase + 80 is the 
port for accessing the application and portbase + 48 is the port where 
the admin console will be available. For this method we therefore define:

- cocome-pickup: portbase 8500, admin 8548, service 8580

In the remaining steps we will use the port numbers from Section 2.1.


3. Install the basic CoCoME version

The pickup shop requires the basic CoCoME version to be running already. 
The required projects can be found in the following repository:

https://github.com/cocome-community-case-study/cocome-cloud-jee-platform-migration

The installation instructions can be found in the repository under 
cocome-maven-parent/doc/
We define the following settings for the basic version of CoCoME:

- Domain name: cocome-logic, admin 4849, service 8181


== Importing and Configuring of the CoCoME Pickup Shop Build ==

1.  Check out git repository from:  https://github.com/cocome-community-case-study/cocome-cloud-jee-web-shop.git
    This can be done via 'git clone https://github.com/cocome-community-case-study/cocome-cloud-jee-web-shop.git'
    or with eclipse 'clone repository' (use  https://github.com/cocome-community-case-study/cocome-cloud-jee-web-shop.git as URI)

1.1 Import the existing maven project in Eclipse with 
    Import -> Maven -> Existing Maven Projects

2.  Select the cocome-shop-project folder in
    the GIT repository to import. There should appear two 
    sub-projects, cloud-auth-provider and cloud-pickup-shop.
    These projects depend on an existing installation of the 
    basic CoCoME version to be available at least in the local
    maven repository.

3.  Once successfully imported, you need to open the cocome-shop-project/pom.xml file.

3.1 Check and change the following settings:
    - pickup.domain to cocome-pickup (  <pickup.domain>....</pickup.domain>  -->   <pickup.domain>cocome-pickup</pickup.domain> )
    - pickup.httpPort to 8580
    - pickup.adminPort to 8548


3.2 Change the <logic.registry.httpPort> to the port you selected in your cocome project  --> check up in cocome's pom.xml  
    (should be <logic.registry.httpPort>8480</logic.registry.httpPort> if you followed the cocome installation guide, but can be different)    

== Compile and Deploy CoCoME Pickup Shop ==

Note: If compilation and deployment fail half through the build and
deployment process, there might be parts up and running which can cause
additional trouble after fixing the issue and trying installation again.
In this case run mvn clean on command line or in Eclipse.

1. Deploy complete implementation

Don't forget to start the webshop glassfish server first!
Either select the cocome-shop-project in Eclipse and execute maven
install or do this on command line as

cd cocome-shop-project
mvn install
(no need to set 'settings', they are already in pom.xml)

2. Register authentication provider

Open localhost:8548 in your browser to open the admin console of the cocome-pickup domain.
There go to Configurations -> server-config -> Security -> Realms and add a new security realm.

- Name: LogicServiceRealm, Class name: org.cocome.cloud.auth.provider.LogicServiceRealm                       //TODO auth jar in domain folder?
                                                                                                              //No access to wsdl etc?

Go back to Configurations -> server-config -> Security and change the Default Realm to the 
new LogicServiceRealm.

Now you need to open the file ${GLASSFISH}/glassfish/domains/cocome-pickup/config/login.conf and add 
the following lines to it.

cocomeLogicRealm {
    org.cocome.cloud.auth.provider.LogicServiceLoginModule required;
};

Note: Maybe you need to redeploy the project after this. To do that execute

cd cocome-shop-project
mvn clean post-clean install

== Undeploy Services ==

To undeploy and shut down Glassfish use Run As -> Maven clean.
If there were problems deploying a subproject, an error may occur
when trying to undeploy this subproject. The order in which the 
projects are deployed and undeployed is the same, so the error 
can normally be ignored. 

== Usage ==

Once you have successfully deployed the projects you can access the 
pickup shop under the following URL:

http://localhost:8580/cloud-pickup-shop/

There you can browse the currently registered products, select a store, 
register a new user or log in with an existing one and purchase products.

== Additional information ==

- There may be errors regarding the target runtime. They may 
  be resolved by installing at least the Glassfish Tools from the  
  Oracle Enterprise Pack for Eclipse (OEPE) from the Eclipse 
  Marketplace. Then add a new Glassfish server in the Servers view
  with the Server root directory of your existing Glassfish installation.
  After this, change the Targeted Runtimes of the ear, ejb, webservice 
  and java-utils projects under Properties -> Targeted Runtimes to
  the newly created glassfish server.

- Add the JDK 7 path to your PATH environment variable if you have 
  problems with running glassfish through the maven install command.
